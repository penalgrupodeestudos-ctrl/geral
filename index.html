<script>
    // Vari√°veis globais para o funcionamento do quiz
    let currentSimuladoName = null;
    let currentQuizData = null;
    let performance = {
        totalQuestions: 0,
        hits: 0,
        errors: 0,
        disciplineBreakdown: {}
    };
    const SIMULADOS_BASE_PATH = './data/';

    // Fun√ß√£o principal para carregar a lista de simulados
    async function loadSimulados() {
        const list = document.getElementById('simulado-list');
        try {
            // Tenta carregar o manifest principal
            const response = await fetch(SIMULADOS_BASE_PATH + 'simulados_manifest.json');
            if (!response.ok) {
                // Se o manifest falhar, tenta carregar diretamente do cache de arquivos (fallback)
                throw new Error(`N√£o foi poss√≠vel carregar o arquivo manifest. Verifique se ele existe em /data/`);
            }
            
            const simuladoFilenames = await response.json(); 

            list.innerHTML = '';
            if (!Array.isArray(simuladoFilenames) || simuladoFilenames.length === 0) {
                list.innerHTML = '<li>Nenhum simulado encontrado no manifest.</li>';
                return;
            }

            simuladoFilenames.forEach(filename => {
                const cleanName = filename.replace(/\.json$/i, ''); 
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <a onclick="loadAndRenderQuiz('${filename}')">${cleanName}</a>
                `;
                list.appendChild(li);
            });
            
            console.info("AVISO ADMINISTRATIVO: Para atualizar a lista de simulados, edite o arquivo /data/simulados_manifest.json.");


        } catch (error) {
            console.error("Erro ao carregar simulados, usando lista de testes (fallback):", error);
            
            // Lista est√°tica de fallback (Ajuste esta lista com seus nomes de arquivo JSON reais!)
            const fallbackFiles = [
                "SIMULADO-POLICIA-PENAL-JSON.json", 
                "SIMULADO-02-IDCAP-60-QUESTOES.json",
                "QUESTOES-AREA-POLICIAL.json",
                "simulado_100_questoes.json",
                "100-QUESTOES-POLICIAL.json",
                "LEGISLA√á√ÉO-ESPEC√çFICA.json"
            ];
            
            list.innerHTML = '';
            fallbackFiles.forEach(filename => {
                const cleanName = filename.replace(/\.json$/i, ''); 
                const li = document.createElement('li');
                li.innerHTML = `<a onclick="loadAndRenderQuiz('${filename}')">${cleanName}</a>`;
                list.appendChild(li);
            });
            list.innerHTML += '<li><small style="text-align:center; padding:10px; color:#adb5bd; display:block;">(Lista de testes carregada)</small></li>';
        }
    }

    // Fun√ß√£o para carregar e renderizar o quiz
    async function loadAndRenderQuiz(filename) {
        currentSimuladoName = filename;
        document.getElementById('current-simulado-name').textContent = `Carregado: ${filename.replace(/\.json$/i, '')}`;
        document.getElementById('main-message').style.display = 'none';
        document.getElementById('performance-report').style.display = 'none';
        
        // Exibir uma mensagem de "Carregando" na √°rea principal para feedback
        const container = document.getElementById('quiz-container');
        container.innerHTML = `<h2 style="text-align: center; color: var(--primary-color); margin-top: 50px;">Carregando ${filename}...</h2>`;
        
        try {
            const response = await fetch(SIMULADOS_BASE_PATH + filename);
            if (!response.ok) {
                throw new Error(`N√£o foi poss√≠vel carregar o arquivo: ${filename}`);
            }
            const data = await response.json();
            
            // L√≥gica de extra√ß√£o de quest√µes (mantida para compatibilidade)
            let quizData;
            if (data.questoes && Array.isArray(data.questoes)) {
                quizData = data.questoes;
            } else if (Array.isArray(data)) {
                quizData = data;
            } else if (data.simulados_policia_penal && Array.isArray(data.simulados_policia_penal[0].questoes)) {
                quizData = data.simulados_policia_penal[0].questoes;
            } else {
                throw new Error("N√£o foi poss√≠vel extrair a lista de quest√µes. Estrutura n√£o reconhecida.");
            }

            if (!quizData || !Array.isArray(quizData) || quizData.length === 0) {
                throw new Error("O JSON foi lido, mas a lista de quest√µes est√° vazia ou incompleta.");
            }

            currentQuizData = quizData;
            renderQuiz(quizData, filename.replace(/\.json$/i, ''));
            document.getElementById('action-buttons-container').style.display = 'block';

        } catch (error) {
            container.innerHTML = `<p style="color: var(--danger-color); text-align: center; font-weight:bold;">ERRO CR√çTICO: N√£o foi poss√≠vel carregar o simulado '${filename}'</p><p style="text-align:center;">Detalhes no console: ${error.message}</p>`;
            console.error("Erro no carregamento:", error);
            document.getElementById('action-buttons-container').style.display = 'none';
        }
    }

    // Otimiza√ß√£o de renderiza√ß√£o de quiz: Usa DocumentFragment para melhor performance.
    function renderQuiz(questions, name) {
        const container = document.getElementById('quiz-container');
        
        // Cabe√ßalho
        container.innerHTML = `
            <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">
                Simulado: ${name}
            </h2>
        `;
        
        const fragment = document.createDocumentFragment();

        questions.forEach((q, index) => {
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.id = `q-card-${index}`;
            questionCard.setAttribute('data-discipline', (q.disciplina || 'Geral').toUpperCase().trim());
            
            // Usa innerHTML para montar o conte√∫do da quest√£o de forma r√°pida
            questionCard.innerHTML = createQuestionHtml(q, index, name);
            fragment.appendChild(questionCard);
        });
        
        // Adiciona o fragmento inteiro de uma s√≥ vez (otimiza√ß√£o)
        container.appendChild(fragment);

        resetPerformance();
        container.scrollTop = 0;
    }

    function createQuestionHtml(q, index, name) {
        const discipline = q.disciplina && q.disciplina.trim() !== '' && q.disciplina.toUpperCase() !== 'IMPORTADO'
                            ? q.disciplina : 'Geral';
        
        let optionsHtml = '';
        // Flexibilidade para diferentes formatos de op√ß√µes/alternativas
        const optionsMap = q.opcoes || (q.alternativas ? q.alternativas.reduce((acc, alt) => {
            acc[alt.letra] = alt.texto;
            return acc;
        }, {}) : {});

        const optionsArray = Object.keys(optionsMap).map(key => ({
            letra: key,
            texto: optionsMap[key]
        }));

        optionsArray.forEach(opt => {
            optionsHtml += `
                <label class="option-label">
                    <input type="radio" name="${name}_q${index}" value="${opt.letra}">
                    <span class="option-letter">${opt.letra})</span> ${opt.texto}
                </label>
            `;
        });

        // Flexibilidade para diferentes campos de explica√ß√£o/gabarito
        const explanation = q.explicacao_professor || q.comentario || 'Nenhuma explica√ß√£o fornecida.';
        const respostaCorreta = q.resposta_correta || q.gabarito || 'N/A';
        const questaoTexto = q.questao || q.enunciado || 'Quest√£o sem texto.';


        const explanationSectionHtml = `
            <div class="explanation-box" id="exp-${index}" style="display:none;">
                <strong>An√°lise Did√°tica do Professor:</strong>
                <p class="explanation-text">**Gabarito: ${respostaCorreta}** - ${explanation}</p>
            </div>
        `;
        
        const noteContent = loadNote(name, index);
        const commentSectionHtml = `
            <div class="comment-section">
                <strong>üñäÔ∏è Notas Pessoais (Coment√°rios):</strong>
                <textarea id="note-q-${index}" placeholder="Use este espa√ßo para anotar o porqu√™ errou, conceitos chave ou pontos de aten√ß√£o para revis√£o futura." >${noteContent}</textarea>
                <div class="note-buttons">
                    <button class="btn-save-note" onclick="saveNote('${name}', ${index})">üíæ Salvar Nota</button>
                    <button class="btn-delete-note" onclick="deleteNote('${name}', ${index})">üóëÔ∏è Excluir Nota</button>
                </div>
            </div>
        `;

        // Retorna a string HTML completa para ser inserida no 'questionCard.innerHTML'
        return `
            <div class="question-header">
                <span class="question-number">Quest√£o ${q.numero || (index + 1)}</span>
                <span class="question-discipline">Disciplina: ${discipline}</span>
            </div>
            <p class="question-text">${questaoTexto}</p>
            <form class="options-form">
                ${optionsHtml}
            </form>
            ${explanationSectionHtml}
            ${commentSectionHtml}
        `;
    }
    
    function resetPerformance() {
         performance = {
            totalQuestions: 0,
            hits: 0,
            errors: 0,
            disciplineBreakdown: {}
        };
    }

    function checkAllAnswers() {
        if (!currentQuizData || currentQuizData.length === 0) {
            alert("Nenhum simulado carregado para corre√ß√£o.");
            return;
        }

        resetPerformance();

        currentQuizData.forEach((q, index) => {
            const questionElement = document.getElementById(`q-card-${index}`);
            const explanationElement = document.getElementById(`exp-${index}`);
            
            if (!questionElement || !explanationElement) return;

            const selected = questionElement.querySelector(`input[name='${currentSimuladoName}_q${index}']:checked`);
            let selectedValue = selected ? selected.value : null;
            const respostaCorreta = q.resposta_correta || q.gabarito; // Flexibilidade
            const isCorrect = selectedValue === respostaCorreta;
            
            updatePerformance(q.disciplina, isCorrect);

            // Mostra a explica√ß√£o
            explanationElement.style.display = 'block';
            

            const labels = questionElement.querySelectorAll('.option-label');
            labels.forEach(label => {
                label.classList.remove('correct', 'incorrect');
            });

            let selectedInput = selected ? selected : null;

            // Highlight correct answer
            const correctLabelInput = questionElement.querySelector(`input[value='${respostaCorreta}']`);
            if (correctLabelInput) {
                correctLabelInput.closest('.option-label').classList.add('correct');
            }

            // Highlight incorrect selection
            if (selectedInput && selectedValue !== respostaCorreta) {
                selectedInput.closest('.option-label').classList.add('incorrect');
            }
        });

        document.getElementById('quiz-container').scrollIntoView({ behavior: 'smooth' });
        alert("Corre√ß√£o conclu√≠da. Verifique as respostas e explica√ß√µes!");
    }

    function updatePerformance(discipline, isCorrect) {
        discipline = (discipline || 'Geral').toUpperCase().trim();
        if (!performance.disciplineBreakdown[discipline]) {
            performance.disciplineBreakdown[discipline] = { total: 0, errors: 0 };
        }
        
        performance.totalQuestions++;
        if (isCorrect) {
            performance.hits++;
        } else {
            performance.errors++;
        }
        
        performance.disciplineBreakdown[discipline].total++;
        if (!isCorrect) {
            performance.disciplineBreakdown[discipline].errors++;
        }
    }
    
    function renderPerformanceReport() {
        const reportContainer = document.getElementById('performance-report');
        const summaryContainer = document.getElementById('performance-summary');
        const weakAreasContainer = document.getElementById('weak-areas');
        
        if (performance.totalQuestions === 0) {
            reportContainer.style.display = 'none';
            alert("Voc√™ precisa responder e corrigir um simulado primeiro para gerar o relat√≥rio.");
            return;
        }

        const hitRate = (performance.hits / performance.totalQuestions) * 100;
        const errorRate = (performance.errors / performance.totalQuestions) * 100;

        let summaryHtml = `
            <h4>üìä Resumo Geral do Simulado:</h4>
            <ul>
                <li>**Total de Quest√µes Corrigidas**: ${performance.totalQuestions}</li>
                <li>**Acertos (‚úÖ)**: ${performance.hits} (${hitRate.toFixed(1)}%)</li>
                <li>**Erros (‚ùå)**: ${performance.errors} (${errorRate.toFixed(1)}%)</li>
            </ul>
        `;
        summaryContainer.innerHTML = summaryHtml;

        let disciplineResults = [];
        for (const disc in performance.disciplineBreakdown) {
            const data = performance.disciplineBreakdown[disc];
            if (data.total > 0) {
                const errorRate = (data.errors / data.total) * 100;
                disciplineResults.push({ discipline: disc, errors: data.errors, total: data.total, errorRate: errorRate });
            }
        }
        
        disciplineResults.sort((a, b) => b.errorRate - a.errorRate);
        
        let weakAreasHtml = '<h4>üéØ Observa√ß√µes: √Åreas de Melhoria e Prioridade de Estudos:</h4>';
        if (disciplineResults.length > 0) {
             weakAreasHtml += '<p>Seu foco principal de revis√£o deve ser nas seguintes disciplinas (ordenadas pela maior taxa de erro):</p><ul>';
            disciplineResults.slice(0, 5).forEach(result => {
                weakAreasHtml += ` 
                    <li> **${result.discipline}**: <span style="color:var(--danger-color);">${result.errors} erros</span> em ${result.total} quest√µes. **Taxa de Erro**: ${result.errorRate.toFixed(1)}%.</li>
                `;
            });
            weakAreasHtml += '</ul>';
        } else {
             weakAreasHtml = '<h4>üéØ Observa√ß√µes:</h4><p>Nenhuma disciplina para revisar. Excelente desempenho!</p>';
        }
        
        weakAreasContainer.innerHTML = weakAreasHtml;
        
        reportContainer.style.display = 'block';
        reportContainer.scrollIntoView({ behavior: 'smooth' });
    }


    function saveNote(simuladoName, index) {
        try {
            const textarea = document.getElementById(`note-q-${index}`);
            const key = `notes_${simuladoName}_${index}`;
            if (textarea.value.trim() === '') {
                localStorage.removeItem(key);
                alert('Nota exclu√≠da.');
            } else {
                localStorage.setItem(key, textarea.value.trim());
                alert('Nota salva com sucesso!');
            }
        } catch (e) {
            console.error("Erro ao salvar a nota no LocalStorage:", e);
            alert('Erro ao salvar a anota√ß√£o. Verifique o console.');
        }
    }

    function deleteNote(simuladoName, index) {
        try {
            const key = `notes_${simuladoName}_${index}`;
            localStorage.removeItem(key);
            document.getElementById(`note-q-${index}`).value = '';
            alert('Nota exclu√≠da.');
        } catch (e) {
            console.error("Erro ao excluir a nota do LocalStorage:", e);
            alert('Erro ao excluir a anota√ß√£o. Verifique o console.');
        }
    }

    function loadNote(simuladoName, index) {
        try {
            const key = `notes_${simuladoName}_${index}`;
            return localStorage.getItem(key) || '';
        } catch (e) {
            console.error("Erro ao carregar a nota do LocalStorage:", e);
            return '';
        }
    }
    
    // Inicializa√ß√£o: Carrega a lista de simulados ao carregar a p√°gina
    window.onload = loadSimulados;

</script>
