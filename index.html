<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise e Revis√£o de Conte√∫do - Simulados Interativos</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Vari√°veis de Tema (Design System B√°sico) */
        :root {
            --primary-color: #004d99; /* Azul Profundo */
            --secondary-color: #fca311; /* Laranja de Destaque */
            --success-color: #28a745; /* Verde para Acerto */
            --danger-color: #dc3545; /* Vermelho para Erro */
            --warning-color: #ffc107; /* Amarelo para Aten√ß√£o */
            --bg-light: #f9fbfd; /* Fundo Leve */
            --bg-dark: #212529; /* Barra Lateral Escura */
            --text-dark: #343a40;
            --text-light: #fff;
            --border-color: #e9ecef;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* ======================================= */
        /* CONFIGURA√á√ÉO RESPONSIVA (Layout)        */
        /* ======================================= */

        /* Padr√£o para Celular (Barra lateral em cima, Conte√∫do em baixo) */
        #sidebar {
            width: 100%; 
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); 
            overflow-y: auto;
        }
        
        @media (min-width: 768px) {
            body {
                display: flex; /* Volta ao layout lado a lado para telas grandes */
            }
            #sidebar {
                width: 300px;
                flex-shrink: 0; 
                height: 100vh; 
                position: sticky; /* Mant√©m a barra lateral fixa no topo */
                top: 0;
                box-shadow: 4px 0 10px rgba(0, 0, 0, 0.15); /* Sombra na lateral */
            }
            #main-content {
                flex-grow: 1;
            }
            header {
                flex-direction: row;
            }
        }
        
        /* CABE√áALHO */
        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: column; /* Empilha no celular */
            gap: 10px;
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem; /* Menor no celular */
            margin: 0;
            text-align: center;
        }
        @media (min-width: 768px) {
             header h1 {
                font-size: 1.8rem;
            }
        }

        /* Bot√£o An√°lise e Revis√£o na Sidebar */
        .btn-sidebar-report {
            padding: 12px 15px;
            background-color: var(--success-color); 
            color: var(--text-light);
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            margin-bottom: 20px;
            transition: background-color 0.2s;
            display: none; 
            width: 100%;
            text-align: center;
            font-size: 1rem;
        }

        .btn-sidebar-report:hover {
            background-color: #1...
    
            
/* AQUI CONTINUA O C√ìDIGO DA BARRA LATERAL (SEM AS FUN√á√ïES JS) */
        </style>
    </head>
<body>

    <div id="sidebar">
        <h2 style="font-family: 'Montserrat', sans-serif; font-size: 1.8rem; text-align: center; margin-bottom: 5px;">
            Plataforma 
        </h2>
        <p style="font-family: 'Roboto', sans-serif; font-size: 0.9rem; text-align: center; color: #ced4da; margin-bottom: 20px;">
            Alta Performance
        </p>

        <h3 style="font-family: 'Roboto', sans-serif; font-size: 1.2rem; margin: 20px 0 10px 0; padding-left: 20px; color: var(--secondary-color);">
            üìÇ Materiais de Apoio
        </h3>
        <ul style="list-style: none; padding: 0; margin-bottom: 30px;">
            <li>
                <a href="./data/pdfs/" target="_blank" style="display: block; padding: 10px 20px; color: var(--text-light); text-decoration: none; background-color: #343a40; cursor: pointer; transition: background-color 0.2s, color 0.2s; border-left: 5px solid var(--secondary-color); font-weight: bold;">
                    üîó Pasta de PDFs (GitHub Data)
                </a>
            </li>
        </ul>
        <h2 style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; text-align: center; margin-bottom: 20px;">
            üìö Simulados Carregados
        </h2>
        
        <ul id="simulado-list">
            <li><a style="text-align: center; opacity: 0.8; font-style: italic;">Carregando simulados...</a></li>
        </ul>

        <button class="btn-sidebar-report" onclick="renderPerformanceReport()">
            An√°lise e Revis√£o
        </button>

        <footer style="text-align: center; padding-top: 20px; border-top: 1px solid #343a40;">
            <p style="font-size: 0.75rem; color: #adb5bd; margin: 0;">
                Desenvolvido para Estudos.
            </p>
        </footer>

    </div>

    <div id="main-content">
        <header>
            <h1 id="quiz-title">Bem-vindo(a) √† Plataforma de Simulados Interativos</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                 <span id="current-simulado-name" style="font-size: 1rem; color: var(--warning-color); font-weight: bold;"></span>
                <button id="toggle-sidebar" class="menu-button" style="display: none;" onclick="toggleSidebar()">
                    ‚ò∞
                </button>
            </div>
           
        </header>

        <div id="quiz-container">
            <h2 id="main-message" style="text-align: center; margin-top: 50px; color: var(--primary-color);">
                Selecione um Simulado na Barra Lateral
            </h2>
            <p style="text-align: center; color: var(--text-dark); max-width: 600px; margin: 20px auto;">
                Escolha qualquer arquivo JSON listado √† esquerda para come√ßar a praticar. O sistema calcular√° seu desempenho em tempo real e permitir√° que voc√™ salve anota√ß√µes em cada quest√£o.
            </p>
        </div>

        <div id="action-buttons-container" style="text-align: center; padding: 20px; margin-top: 20px; display: none;">
            <button class="btn-check-all" onclick="checkAllAnswers()">
                Corrigir Simulado
            </button>
        </div>

         <div id="performance-report" style="display: none;">
             <h3>üìà Relat√≥rio de Desempenho</h3>
             <div id="performance-summary"></div>
             <div id="weak-areas"></div>
        </div>

    </div>

    <script>
        // ===================================================================
        // VARI√ÅVEIS GLOBAIS
        // ===================================================================
        let currentSimuladoName = null;
        let currentQuizData = null;
        let performance = {
            totalQuestions: 0,
            hits: 0,
            errors: 0,
            disciplineBreakdown: {}
        };

        // ===================================================================
        // CONFIGURA√á√ÉO DE ROTA (Onde buscar os simulados JSON)
        // ===================================================================
        const SIMULADOS_BASE_PATH = './data/';

        // ===================================================================
        // FUN√á√ïES DE CARREGAMENTO DE ARQUIVOS
        // ===================================================================

        // Fun√ß√£o principal para carregar o arquivo manifest e listar os simulados
        async function loadSimulados() {
            const list = document.getElementById('simulado-list');
            try {
                // 1. Tentar carregar a lista de arquivos (manifest)
                const response = await fetch(SIMULADOS_BASE_PATH + 'simulados_manifest.json');
                if (!response.ok) {
                    throw new Error(`N√£o foi poss√≠vel carregar o arquivo manifest.`);
                }
                
                const simuladoFilenames = await response.json(); 

                list.innerHTML = '';
                if (!Array.isArray(simuladoFilenames) || simuladoFilenames.length === 0) {
                    list.innerHTML = '<li>Nenhum simulado encontrado no manifest.</li>';
                    return;
                }

                simuladoFilenames.forEach(filename => {
                    const cleanName = filename.replace(/\.json$/i, ''); 
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a onclick="loadAndRenderQuiz('${filename}')">${cleanName}</a>
                    `;
                    list.appendChild(li);
                });
                
                // Mensagem administrativa discreta no console
                console.info("AVISO ADMINISTRATIVO: Para atualizar a lista de simulados, edite o arquivo /data/simulados_manifest.json.");


            } catch (error) {
                console.error("Erro ao carregar simulados, usando lista de testes (fallback):", error);
                
                // Lista est√°tica de fallback (Ajuste esta lista com seus nomes de arquivo JSON reais!)
                const fallbackFiles = [
                    "SIMULADO-POLICIA-PENAL-JSON.json", 
                    "SIMULADO-02-IDCAP-60-QUESTOES.json",
                    "SIMULADO-DIREITOS-HUMANOS-JSON.json",
                    "SIMULADO-IASES-JSON-COM-GABARITO.json",
                    "QUESTOES-AREA-POLICIAL.json",
                    "simulado_100_questoes.json",
                    "100-QUESTOES-POLICIAL.json",
                    "QUESTOES-GERAIS.json.json"
                ];
                
                list.innerHTML = '';
                fallbackFiles.forEach(filename => {
                    const cleanName = filename.replace(/\.json$/i, ''); 
                    const li = document.createElement('li');
                    li.innerHTML = `<a onclick="loadAndRenderQuiz('${filename}')">${cleanName}</a>`;
                    list.appendChild(li);
                });
                list.innerHTML += '<li><small style="color:#adb5bd;">(Lista de testes carregada)</small></li>';
            }
        }

        // Fun√ß√£o para carregar o quiz JSON
        async function loadAndRenderQuiz(filename) {
            currentSimuladoName = filename;
            document.getElementById('current-simulado-name').textContent = `Carregado: ${filename.replace(/\.json$/i, '')}`;
            document.getElementById('main-message').style.display = 'none';
            document.getElementById('performance-report').style.display = 'none';
            
            try {
                const response = await fetch(SIMULADOS_BASE_PATH + filename);
                if (!response.ok) {
                    throw new Error(`N√£o foi poss√≠vel carregar o arquivo: ${filename}`);
                }
                const data = await response.json();
                
                // Extrai a lista de quest√µes do objeto JSON
                let quizData;
                if (data.questoes && Array.isArray(data.questoes)) {
                    // Padr√£o 1: { ..., "questoes": [...] }
                    quizData = data.questoes;
                } else if (Array.isArray(data)) {
                    // Padr√£o 2: √â um array de quest√µes [ {..}, {..} ]
                    quizData = data;
                } else if (data.simulados_policia_penal && Array.isArray(data.simulados_policia_penal[0].questoes)) {
                    // Padr√£o 3: { simulados_policia_penal: [ { questoes: [...] } ] } (Exemplo de JSON aninhado)
                    quizData = data.simulados_policia_penal[0].questoes;
                } else {
                    throw new Error("N√£o foi poss√≠vel extrair a lista de quest√µes. Estrutura n√£o reconhecida.");
                }

                if (!quizData || !Array.isArray(quizData) || quizData.length === 0) {
                    throw new Error("O JSON foi lido, mas a lista de quest√µes est√° vazia ou incompleta.");
                }

                currentQuizData = quizData;
                renderQuiz(quizData, filename.replace(/\.json$/i, ''));
                document.getElementById('action-buttons-container').style.display = 'block';

            } catch (error) {
                const container = document.getElementById('quiz-container');
                container.innerHTML = `<p style="color: var(--danger-color); text-align: center;">Erro ao carregar o simulado: ${error.message}</p>`;
                console.error("Erro no carregamento:", error);
                document.getElementById('action-buttons-container').style.display = 'none';
            }
        }

        // ===================================================================
        // FUN√á√ïES DE RENDERING E INTERFACE
        // ===================================================================

        function renderQuiz(questions, name) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">
                    Simulado: ${name}
                </h2>
            `;
            
            questions.forEach((q, index) => {
                const questionHtml = createQuestionHtml(q, index, name);
                container.innerHTML += questionHtml;
            });

            // Reseta a performance e carrega as anota√ß√µes
            resetPerformance();
            // Reseta a rolagem para o topo
            container.scrollTop = 0;
        }

        function createQuestionHtml(q, index, name) {
            // Tenta obter o nome da disciplina, tratando casos como "Importado" ou vazio
            const discipline = q.disciplina && q.disciplina.trim() !== '' && q.disciplina.toUpperCase() !== 'IMPORTADO'
                               ? q.disciplina : 'Geral';
            
            let optionsHtml = '';
            // Cria um array de op√ß√µes no formato { letra: 'A', texto: 'Op√ß√£o A' }
            const optionsArray = Object.keys(q.opcoes || {}).map(key => ({
                letra: key,
                texto: q.opcoes[key]
            }));

            // Embaralha as op√ß√µes (Recurso opcional, mas √∫til)
            // optionsArray.sort(() => Math.random() - 0.5); 

            optionsArray.forEach(opt => {
                optionsHtml += `
                    <label class="option-label">
                        <input type="radio" name="${name}_q${index}" value="${opt.letra}">
                        <span class="option-letter">${opt.letra})</span> ${opt.texto}
                    </label>
                `;
            });

            const explanation = q.explicacao_professor || 'Nenhuma explica√ß√£o fornecida.';
            const respostaCorreta = q.resposta_correta || 'N/A';

            const explanationSectionHtml = `
                <div class="explanation-box" id="exp-${index}" style="display:none;">
                    <strong>An√°lise Did√°tica do Professor:</strong>
                    <p class="explanation-text">**Gabarito: ${respostaCorreta || 'N/A'}** - ${explanation}</p>
                </div>
            `;
            
            const noteContent = loadNote(name, index);
            const commentSectionHtml = `
                <div class="comment-section">
                    <strong>üñäÔ∏è Notas Pessoais (Coment√°rios):</strong>
                    <textarea id="note-q-${index}" placeholder="Use este espa√ßo para anotar o porqu√™ errou, conceitos chave ou pontos de aten√ß√£o para revis√£o futura." >${noteContent}</textarea>
                    <div class="note-buttons">
                        <button class="btn-save-note" onclick="saveNote('${name}', ${index})">üíæ Salvar Nota</button>
                        <button class="btn-delete-note" onclick="deleteNote('${name}', ${index})">üóëÔ∏è Excluir Nota</button>
                    </div>
                </div>
            `;

            return `
                <div class="question-card" id="q-card-${index}" data-discipline="${discipline}">
                    <div class="question-header">
                        <span class="question-number">Quest√£o ${q.numero || (index + 1)}</span>
                        <span class="question-discipline">Disciplina: ${discipline}</span>
                    </div>
                    <p class="question-text">${q.questao}</p>
                    <form class="options-form">
                        ${optionsHtml}
                    </form>
                    ${explanationSectionHtml}
                    ${commentSectionHtml}
                </div>
            `;
        }
        
        // ===================================================================
        // FUN√á√ïES DE CORRE√á√ÉO
        // ===================================================================

        function resetPerformance() {
             performance = {
                totalQuestions: 0,
                hits: 0,
                errors: 0,
                disciplineBreakdown: {}
            };
        }

        function checkAllAnswers() {
            if (!currentQuizData || currentQuizData.length === 0) {
                alert("Nenhum simulado carregado para corre√ß√£o.");
                return;
            }

            resetPerformance(); // Zera o contador antes de iniciar a corre√ß√£o

            currentQuizData.forEach((q, index) => {
                const questionElement = document.getElementById(`q-card-${index}`);
                const explanationElement = document.getElementById(`exp-${index}`);
                
                if (!questionElement || !explanationElement) return;

                const selected = questionElement.querySelector(`input[name='${currentSimuladoName}_q${index}']:checked`);
                let selectedValue = selected ? selected.value : null;
                const isCorrect = selectedValue === q.resposta_correta;
                
                // 1. Atualizar Performance
                updatePerformance(q.disciplina, isCorrect);

                // 2. Mostrar Explica√ß√£o e Feedback
                if (explanationElement.style.display === 'none' || explanationElement.style.display === '') {
                    explanationElement.style.display = 'block'; // Mostra a explica√ß√£o
                }

                // Reset classes
                const labels = questionElement.querySelectorAll('.option-label');
                labels.forEach(label => {
                    label.classList.remove('correct', 'incorrect');
                });

                // Get selected option
                let selectedInput = selected ? selected : null;

                // Highlight correct answer
                const correctLabelInput = questionElement.querySelector(`input[value='${q.resposta_correta}']`);
                if (correctLabelInput) {
                    correctLabelInput.closest('.option-label').classList.add('correct');
                }

                // Highlight incorrect selection
                if (selectedInput && selectedValue !== q.resposta_correta) {
                    selectedInput.closest('.option-label').classList.add('incorrect');
                }
            });

            // Rolagem suave para o topo da primeira quest√£o
            document.getElementById('quiz-container').scrollIntoView({ behavior: 'smooth' });
            alert("Corre√ß√£o conclu√≠da. Verifique as respostas e explica√ß√µes!");
        }

        // ===================================================================
        // FUN√á√ïES DE PERFORMANCE E INTERATIVIDADE
        // ===================================================================
        
        function updatePerformance(discipline, isCorrect) {
            discipline = (discipline || 'Geral').toUpperCase().trim();
            if (!performance.disciplineBreakdown[discipline]) {
                performance.disciplineBreakdown[discipline] = { total: 0, errors: 0 };
            }
            
            performance.totalQuestions++;
            if (isCorrect) {
                performance.hits++;
            } else {
                performance.errors++;
            }
            
            performance.disciplineBreakdown[discipline].total++;
            if (!isCorrect) {
                performance.disciplineBreakdown[discipline].errors++;
            }
        }
        
        function renderPerformanceReport() {
            const reportContainer = document.getElementById('performance-report');
            const summaryContainer = document.getElementById('performance-summary');
            const weakAreasContainer = document.getElementById('weak-areas');
            
            if (performance.totalQuestions === 0) {
                reportContainer.style.display = 'none';
                alert("Voc√™ precisa responder e corrigir um simulado primeiro para gerar o relat√≥rio.");
                return;
            }

            const hitRate = (performance.hits / performance.totalQuestions) * 100;
            const errorRate = (performance.errors / performance.totalQuestions) * 100;

            let summaryHtml = `
                <h4>üìä Resumo Geral do Simulado:</h4>
                <ul>
                    <li>**Total de Quest√µes Corrigidas**: ${performance.totalQuestions}</li>
                    <li>**Acertos (‚úÖ)**: ${performance.hits} (${hitRate.toFixed(1)}%)</li>
                    <li>**Erros (‚ùå)**: ${performance.errors} (${errorRate.toFixed(1)}%)</li>
                </ul>
            `;
            summaryContainer.innerHTML = summaryHtml;

            let disciplineResults = [];
            for (const disc in performance.disciplineBreakdown) {
                const data = performance.disciplineBreakdown[disc];
                if (data.total > 0) {
                    const errorRate = (data.errors / data.total) * 100;
                    disciplineResults.push({ discipline: disc, errors: data.errors, total: data.total, errorRate: errorRate });
                }
            }
            
            disciplineResults.sort((a, b) => b.errorRate - a.errorRate);
            
            let weakAreasHtml = '<h4>üéØ Observa√ß√µes: √Åreas de Melhoria e Prioridade de Estudos:</h4>';
            if (disciplineResults.length > 0) {
                 weakAreasHtml += '<p>Com base no seu desempenho, seu foco principal de revis√£o deve ser nas seguintes disciplinas (ordenadas pela maior taxa de erro):</p><ul>';
                disciplineResults.slice(0, 5).forEach(result => {
                    weakAreasHtml += ` 
                        <li> **${result.discipline}**: <span style="color:var(--danger-color);">${result.errors} erros</span> em ${result.total} quest√µes. **Taxa de Erro**: ${result.errorRate.toFixed(1)}%.</li>
                    `;
                });
                weakAreasHtml += '</ul>';
            } else {
                 weakAreasHtml = '<h4>üéØ Observa√ß√µes:</h4><p>Nenhuma disciplina para revisar. Excelente desempenho!</p>';
            }
            
            weakAreasContainer.innerHTML = weakAreasHtml;
            
            reportContainer.style.display = 'block';
            reportContainer.scrollIntoView({ behavior: 'smooth' });
        }


        // ===================================================================
        // FUN√á√ïES DE NOTAS PESSOAIS (LocalStorage)
        // ===================================================================

        function saveNote(simuladoName, index) {
            try {
                const textarea = document.getElementById(`note-q-${index}`);
                const key = `notes_${simuladoName}_${index}`;
                if (textarea.value.trim() === '') {
                    localStorage.removeItem(key);
                    alert('Nota exclu√≠da.');
                } else {
                    localStorage.setItem(key, textarea.value.trim());
                    alert('Nota salva com sucesso!');
                }
            } catch (e) {
                console.error("Erro ao salvar a nota no LocalStorage:", e);
                alert('Erro ao salvar a anota√ß√£o. Verifique o console.');
            }
        }

        function deleteNote(simuladoName, index) {
            try {
                const key = `notes_${simuladoName}_${index}`;
                localStorage.removeItem(key);
                document.getElementById(`note-q-${index}`).value = '';
                alert('Nota exclu√≠da.');
            } catch (e) {
                console.error("Erro ao excluir a nota do LocalStorage:", e);
                alert('Erro ao excluir a anota√ß√£o. Verifique o console.');
            }
        }

        function loadNote(simuladoName, index) {
            try {
                const key = `notes_${simuladoName}_${index}`;
                return localStorage.getItem(key) || '';
            } catch (e) {
                console.error("Erro ao carregar a nota do LocalStorage:", e);
                return '';
            }
        }
        
        // ===================================================================
        // FUN√á√ÉO DE TOGGLE (PARA MOBILE)
        // ===================================================================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggle-sidebar');
            
            if (sidebar.style.display === 'none' || sidebar.style.display === '') {
                sidebar.style.display = 'block';
                // Em telas maiores, isso n√£o deve acontecer, mas previne problemas
                if (window.innerWidth < 768) {
                     sidebar.style.position = 'absolute';
                     sidebar.style.zIndex = '1000';
                     sidebar.style.height = 'auto';
                     toggleButton.textContent = '‚úï';
                }
            } else {
                if (window.innerWidth < 768) {
                    sidebar.style.display = 'none';
                    toggleButton.textContent = '‚ò∞';
                }
            }
        }

        // Inicializa√ß√£o: Carrega a lista de simulados ao carregar a p√°gina
        window.onload = loadSimulados;

    </script>

</body>
</html>
