<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJETO SABER 3.4 - Pol√≠cia Penal ES</title>
<style>
/* ===== estilos (mantidos e organizados) ===== */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; background:linear-gradient(135deg,#1e3c72,#2a5298); color:#222; min-height:100vh; padding:18px}
.container{max-width:1200px;margin:0 auto}
header{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;padding:18px;border-radius:12px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between}
header h1{font-size:1.4rem}
.menu-principal{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-bottom:18px}
.card-simulado{background:white;padding:16px;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,.12);cursor:pointer;transition:transform .18s}
.card-simulado:hover{transform:translateY(-6px)}
.card-simulado h3{color:#163a63;margin-bottom:8px}
.card-simulado .info{background:#f6f8fa;padding:8px;border-radius:8px;font-size:.92rem}
.btn{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.15)}
.btn.small{padding:6px 10px;font-size:.9rem}
.hidden{display:none!important}

/* quiz */
.quiz-wrap{background:#fff;border-radius:12px;padding:16px;box-shadow:0 12px 36px rgba(0,0,0,.12)}
.quiz-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.stats{display:flex;gap:10px;align-items:center}
.stat-box{background:#f3f6f9;padding:8px 12px;border-radius:8px;color:#163a63;font-weight:700}
.enunciado{background:#fbfdff;padding:14px;border-radius:10px;border-left:4px solid #3498db;margin-bottom:12px;line-height:1.6}
.opcoes{display:grid;gap:10px;margin-bottom:12px}
.opcao{background:#fff;padding:12px;border-radius:8px;border:2px solid #eee;cursor:pointer;transition:all .14s}
.opcao:hover{transform:translateY(-4px);border-color:#3498db}
.opcao.correta{background:#d4edda;border-color:#28a745;color:#155724}
.opcao.incorreta{background:#f8d7da;border-color:#dc3545;color:#721c24}
.explicacao{background:#eef8ff;padding:10px;border-radius:8px;border-left:4px solid #2b9edb;margin-top:8px;display:none}
.note-area{background:#fff7e6;padding:12px;border-radius:8px;border-left:4px solid #ffc107;margin-top:12px}
.note-area textarea{width:100%;min-height:90px;padding:10px;border-radius:6px;border:1px solid #e6e6e6;font-family:inherit}
.note-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* admin modal */
#adminModal{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999;padding:18px}
#adminPanel{background:linear-gradient(180deg,#fff,#f6f9ff);padding:14px;border-radius:10px;width:100%;max-width:1100px;box-shadow:0 18px 48px rgba(0,0,0,.25)}
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
textarea.code{width:100%;height:320px;font-family:monospace;padding:12px;border-radius:8px;border:1px solid #e2e8f0}
.controls{display:flex;gap:8px;align-items:center;margin-top:10px}
.tab-btns{display:flex;gap:8px;margin-bottom:8px}
.tab-btn{padding:8px 12px;border-radius:8px;border:1px solid #d6dbe6;background:#f8f9fb;cursor:pointer}
.tab-btn.active{background:#3498db;color:#fff;border-color:#2980b9}
.kv{font-size:.9rem;color:#333;margin-left:auto}

/* responsive */
@media(max-width:900px){.admin-grid{grid-template-columns:1fr}.menu-principal{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<header>
  <div>
    <h1>üéì PROJETO SABER 3.4</h1>
    <div style="opacity:.9">Simulados Pol√≠cia Penal ES ‚Äî Conversor Inteligente</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn ghost" onclick="abrirAdministrador()">Administrador</button>
    <button class="btn" onclick="location.reload()">Recarregar</button>
  </div>
</header>

<!-- menu principal -->
<div id="telaPrincipal">
  <div class="menu-principal" id="menuSimulados"></div>
</div>

<!-- quiz area -->
<div id="quizArea" class="hidden">
  <div class="quiz-wrap">
    <div class="quiz-header">
      <div>
        <strong id="tituloSimulado">Simulado</strong>
        <div style="font-size:.9rem;color:#666" id="descricaoSimulado"></div>
      </div>
      <div class="stats">
        <div class="stat-box">Q <span id="numQuestao">0</span>/<span id="totalQuestoes">0</span></div>
        <div class="stat-box">‚úî <span id="acertos">0</span></div>
        <div class="stat-box">‚úñ <span id="erros">0</span></div>
        <div class="stat-box">‚≠ê <span id="pontos">0</span></div>
      </div>
    </div>

    <div class="enunciado" id="enunciado">Enunciado</div>
    <div class="opcoes" id="opcoes"></div>
    <div class="explicacao" id="explicacao"></div>

    <div class="note-area" id="noteArea">
      <strong>Notas Pessoais</strong>
      <textarea id="notaTexto" placeholder="Escreva sua anota√ß√£o..."></textarea>
      <div class="note-actions">
        <button class="btn small" onclick="gravarNota()">üíæ Gravar</button>
        <button class="btn small" style="background:#e74c3c" onclick="excluirNota()">üóëÔ∏è Excluir</button>
      </div>
      <div style="font-size:.9rem;color:#666;margin-top:8px" id="notaInfo"></div>
    </div>

<div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
	      <button class="btn" onclick="questaoAnterior()">‚Üê Anterior</button>
	      <button class="btn" onclick="questaoProxima()">Pr√≥xima ‚Üí</button>
	      <button class="btn secondary" onclick="finalizarSimulado()">Finalizar</button>
	      <button class="btn ghost" style="background:#e74c3c;color:#fff" onclick="limparSimulado()">Limpar Simulado</button>
	      <button class="btn ghost" onclick="voltarMenu()">Voltar</button>
	    </div>
  </div>
</div>

<!-- resultado -->
<div id="resultadoArea" class="hidden" style="margin-top:12px">
  <div class="quiz-wrap">
    <h2>üìä Resultado</h2>
    <p><strong>Acertos:</strong> <span id="resAcertos">0</span></p>
    <p><strong>Erros:</strong> <span id="resErros">0</span></p>
    <p><strong>Pontua√ß√£o:</strong> <span id="resPontuacao">0%</span></p>
    <div style="margin-top:12px"><button class="btn" onclick="voltarMenu()">Voltar ao Menu</button></div>
  </div>
</div>

<!-- admin modal -->
<div id="adminModal" class="hidden">
  <div id="adminPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>üîê Painel Administrador</strong></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" onclick="fecharAdministrador()">Fechar Painel</button>
      </div>
    </div>

    <!-- login -->
    <div id="adminLogin">
      <p style="margin-bottom:6px">Protegido por senha. (Senha padr√£o: <strong>admin123</strong>)</p>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="adminSenha" type="password" placeholder="Senha" style="padding:8px;border-radius:6px;border:1px solid #cfd8e3" />
        <button class="btn" onclick="validarAdmin()">Entrar</button>
      </div>
    </div>

    <!-- content -->
    <div id="adminContent" class="hidden" style="margin-top:10px">
      <div class="tab-btns">
        <div id="tabTextoBtn" class="tab-btn">Texto ‚Üí JSON</div>
        <div id="tabConversorBtn" class="tab-btn">Conversor JSON</div>
        <div style="margin-left:auto" class="kv">Fechar conversor: <button class="btn ghost small" onclick="fecharConversor()">Fechar Conversor</button></div>
      </div>

      <!-- Texto -> JSON (padr√£o aberto ao entrar no admin) -->
      <div id="tabTexto" class="tab">
        <div class="admin-grid">
          <div>
            <h4>Texto base (cole aqui)</h4>
            <textarea id="origTexto" class="code" placeholder="Cole texto da prova, enunciados e alternativas aqui. Pode ser texto livre, ser√° detectado automaticamente."></textarea>
          </div>
          <div>
            <h4>JSON SABER (gerado)</h4>
            <textarea id="jsonTexto" class="code" readonly placeholder="O JSON gerado aparecer√° aqui"></textarea>
          </div>
        </div>
        <div class="controls">
          <button class="btn" onclick="converterTexto()">Converter Texto ‚Üí JSON</button>
          <button class="btn" onclick="copiarTextoJson()">Copiar</button>
          <button class="btn" onclick="baixarTextoJson()">Baixar .json</button>
          <button class="btn ghost" onclick="limparTextoConversor()">Limpar</button>
          <div style="margin-left:auto;color:#333;font-size:.9rem">Detecta JSON embutido ou gera do texto livre</div>
        </div>
      </div>

      <!-- Conversor JSON -->
      <div id="tabConversor" class="tab hidden" style="margin-top:12px">
        <div class="admin-grid">
          <div>
            <h4>JSON Original</h4>
            <textarea id="origJson" class="code" placeholder='Cole aqui JSON (array ou {"questoes":[...]})'></textarea>
          </div>
          <div>
            <h4>JSON Convertido (SABER)</h4>
            <textarea id="convJson" class="code" readonly placeholder="Resultado aparecer√° aqui"></textarea>
          </div>
        </div>
        <div class="controls">
          <button class="btn" onclick="converterAdmin()">Converter</button>
          <button class="btn" onclick="copiarConvertido()">Copiar</button>
          <button class="btn" onclick="baixarConvertido()">Baixar</button>
          <button class="btn ghost" onclick="limparConversor()">Limpar</button>
          <div style="margin-left:auto;color:#333;font-size:.9rem">Converte alternativas objeto ‚Üí array e letras ‚Üí √≠ndices</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ====== Vari√°veis e config ====== */
const ADMIN_PASSWORD = 'admin123';
let simulados = {}, questoesFiltradas = [], simuladoAtual = null, questaoAtual = 0, respostas = {};

/* ====== Fun√ß√µes b√°sicas (manifest, menu) ====== */
async function carregarManifest(){
  try {
    const r = await fetch('data/simulados-manifest.json');
    if(!r.ok) throw new Error('Manifest n√£o encontrado (HTTP '+r.status+')');
    simulados = await r.json();
    montarMenu();
  } catch(e) {
    console.error(e);
    document.getElementById('menuSimulados').innerHTML = '<div style="color:white;padding:10px">Erro ao carregar manifest.</div>';
  }
}
function montarMenu(){
  const menu = document.getElementById('menuSimulados');
  menu.innerHTML = '';
  for(const [id,s] of Object.entries(simulados)){
    const card = document.createElement('div');
    card.className = 'card-simulado';
    card.innerHTML = `<h3>üìã ${s.nome}</h3><div class="info">${s.total||'--'} Quest√µes<br>${s.descricao||''}</div><div style="margin-top:10px"><button class="btn" onclick="iniciarSimulado(${id})">Fazer</button></div>`;
    menu.appendChild(card);
  }
}

/* ====== Iniciar simulado (busca arquivo) ====== */
async function iniciarSimulado(id){
  try {
    simuladoAtual = id;
    const s = simulados[id];
    if(!s) throw new Error('Simulado n√£o encontrado');
    let caminho = s.arquivo || s.file || '';
    if(!caminho) throw new Error('Nenhum arquivo configurado no manifest');
    if(!caminho.startsWith('data/')) caminho = 'data/' + caminho;
    const r = await fetch(caminho);
    if(!r.ok) throw new Error('Arquivo do simulado n√£o encontrado (HTTP '+r.status+')');
    const dados = await r.json();
    questoesFiltradas = Array.isArray(dados) ? dados : (dados.questoes || []);
    if(!questoesFiltradas.length) throw new Error('Sem quest√µes no arquivo');
    // carregar respostas salvas
    const saved = localStorage.getItem('respostas_simulado_'+simuladoAtual);
    respostas = saved ? JSON.parse(saved) : {};
    document.getElementById('telaPrincipal').classList.add('hidden');
    document.getElementById('quizArea').classList.remove('hidden');
    document.getElementById('tituloSimulado').textContent = s.nome;
    document.getElementById('descricaoSimulado').textContent = s.descricao || '';
    document.getElementById('totalQuestoes').textContent = questoesFiltradas.length;
    questaoAtual = 0;
    atualizarEstatisticas();
    exibirQuestao();
  } catch(e) {
    console.error(e);
    alert('Erro ao iniciar simulado: ' + (e.message||e));
  }
}

/* ====== Exibir quest√£o, selecionar, stats ====== */
function exibirQuestao(){
  const q = questoesFiltradas[questaoAtual];
  if(!q) return;
  document.getElementById('numQuestao').textContent = questaoAtual+1;
  document.getElementById('enunciado').innerHTML = `<strong>Q${questaoAtual+1}.</strong> ${q.enunciado || q.questao || ''}`;

  // normaliza opcoes: se objeto A:..,B:.. -> array
  let op = q.opcoes || q.alternativas || q.options || [];
  if(!Array.isArray(op) && typeof op === 'object') op = Object.values(op);
  q.opcoes = op;

  const cont = document.getElementById('opcoes');
  cont.innerHTML = '';
  op.forEach((txt, idx) => {
    const d = document.createElement('div');
    d.className = 'opcao';
    d.textContent = `${String.fromCharCode(65+idx)}) ${txt}`;
    d.onclick = () => selecionarOpcao(idx);
    cont.appendChild(d);
  });

  // explicacao
  const expEl = document.getElementById('explicacao');
  if(q.explicacao) {
    expEl.innerHTML = `<strong>Explica√ß√£o:</strong><br>${q.explicacao}`;
    expEl.style.display = 'none'; // mostra s√≥ ap√≥s responder
  } else {
    expEl.innerHTML = '';
    expEl.style.display = 'none';
  }

  // carregar nota
  carregarNotaTela();

  // mostrar respostas j√° dadas (pinta correta/incorreta)
  const resp = respostas[questaoAtual];
  if(resp !== undefined && resp !== null) {
    marcarOpcoesVisuais(resp, q);
  }
}

function selecionarOpcao(indice){
  const q = questoesFiltradas[questaoAtual];
  if(!q) return;
  // normaliza gabarito se for letra
  let g = q.gabarito ?? q.resposta ?? q.resposta_correta ?? null;
  if(typeof g === 'string') {
    const idx = g.trim().toUpperCase().charCodeAt(0)-65;
    g = isNaN(idx) ? null : idx;
  }
  q.gabarito = (g===null||g===undefined) ? q.gabarito : g;

  respostas[questaoAtual] = indice;
  localStorage.setItem('respostas_simulado_'+simuladoAtual, JSON.stringify(respostas));

  marcarOpcoesVisuais(indice, q);
  if(q.explicacao) document.getElementById('explicacao').style.display = 'block';
  atualizarEstatisticas();
}

function marcarOpcoesVisuais(indice, q) {
  document.querySelectorAll('.opcao').forEach((el, idx) => {
    el.classList.remove('correta','incorreta');
    el.disabled = true;
    if(q.gabarito !== null && q.gabarito !== undefined && idx === q.gabarito) el.classList.add('correta');
    if(idx === indice && idx !== q.gabarito) el.classList.add('incorreta');
  });
}

function atualizarEstatisticas(){
  let ac=0, er=0;
  questoesFiltradas.forEach((q, idx) => {
    const resp = respostas[idx];
    if(resp === undefined || resp === null) return;
    let g = q.gabarito ?? q.resposta ?? q.resposta_correta ?? null;
    if(typeof g === 'string') { const idxg = g.trim().toUpperCase().charCodeAt(0)-65; g = isNaN(idxg)?null:idxg; }
    if(g !== null && resp === g) ac++; else er++;
  });
  const pts = ac;
  document.getElementById('acertos').textContent = ac;
  document.getElementById('erros').textContent = er;
  document.getElementById('pontos').textContent = pts;
  document.getElementById('resAcertos').textContent = ac;
  document.getElementById('resErros').textContent = er;
  document.getElementById('resPontuacao').textContent = questoesFiltradas.length ? Math.round((ac/questoesFiltradas.length)*100) + '%' : '0%';
}

/* navega√ß√£o */
function questaoProxima(){ if(questaoAtual < questoesFiltradas.length-1) { questaoAtual++; exibirQuestao(); } else finalizarSimulado(); }
function questaoAnterior(){ if(questaoAtual>0) { questaoAtual--; exibirQuestao(); } }
function finalizarSimulado(){ atualizarEstatisticas(); document.getElementById('quizArea').classList.add('hidden'); document.getElementById('resultadoArea').classList.remove('hidden'); }
function voltarMenu(){ document.getElementById('quizArea').classList.add('hidden'); document.getElementById('resultadoArea').classList.add('hidden'); document.getElementById('telaPrincipal').classList.remove('hidden'); }

	function limparSimulado(){
	  if(!confirm('Tem certeza que deseja limpar o progresso deste simulado e reiniciar do zero?')) return;
	  // 1. Limpar respostas do localStorage
	  localStorage.removeItem('respostas_simulado_'+simuladoAtual);
	  // 2. Limpar notas pessoais (opcional, mas recomendado para um "reset total")
	  // Como as notas s√£o salvas por quest√£o, vamos iterar e remover.
	  for(let i=0; i<questoesFiltradas.length; i++){
	    localStorage.removeItem(`nota_simulado_${simuladoAtual}_q${i}`);
	  }
	  // 3. Resetar vari√°veis de estado
	  respostas = {};
	  questaoAtual = 0;
	  // 4. Recarregar a quest√£o atual (que ser√° a primeira) e atualizar estat√≠sticas
	  atualizarEstatisticas();
	  exibirQuestao();
	  alert('Simulado limpo e reiniciado com sucesso!');
	}

/* ====== Notas por quest√£o (localStorage) ====== */
function carregarNotaTela() {
  const key = `nota_simulado_${simuladoAtual}_q${questaoAtual}`;
  const t = localStorage.getItem(key) || '';
  document.getElementById('notaTexto').value = t;
  document.getElementById('notaInfo').textContent = t ? 'Anota√ß√£o salva.' : 'Sem anota√ß√£o para esta quest√£o.';
}
function gravarNota(){
  const key = `nota_simulado_${simuladoAtual}_q${questaoAtual}`;
  const txt = document.getElementById('notaTexto').value || '';
  localStorage.setItem(key, txt);
  document.getElementById('notaInfo').textContent = 'Anota√ß√£o salva.';
  alert('Anota√ß√£o salva localmente.');
}
function excluirNota(){
  const key = `nota_simulado_${simuladoAtual}_q${questaoAtual}`;
  localStorage.removeItem(key);
  document.getElementById('notaTexto').value = '';
  document.getElementById('notaInfo').textContent = 'Anota√ß√£o exclu√≠da.';
  alert('Anota√ß√£o exclu√≠da.');
}

/* ====== Admin open/close/tab logic ====== */
function abrirAdministrador(){
  document.getElementById('adminModal').classList.remove('hidden');
  document.getElementById('adminLogin').classList.remove('hidden');
  document.getElementById('adminContent').classList.add('hidden');
  // set default tab Texto->JSON active visually
  setTabActive('texto');
}
function fecharAdministrador(){ document.getElementById('adminModal').classList.add('hidden'); }
function validarAdmin(){
  const s = document.getElementById('adminSenha').value;
  if(s === ADMIN_PASSWORD){
    document.getElementById('adminLogin').classList.add('hidden');
    document.getElementById('adminContent').classList.remove('hidden');
    // abrir aba Texto por padr√£o
    setTabActive('texto');
  } else alert('Senha incorreta.');
}
function setTabActive(name){
  // name: 'texto' or 'conversor'
  document.getElementById('tabTextoBtn').classList.toggle('active', name === 'texto');
  document.getElementById('tabConversorBtn').classList.toggle('active', name === 'conversor');
  document.getElementById('tabTexto').classList.toggle('hidden', name !== 'texto');
  document.getElementById('tabConversor').classList.toggle('hidden', name !== 'conversor');
  // if admin content visible and texto open, focus
  if(!document.getElementById('adminContent').classList.contains('hidden')) {
    if(name === 'texto') document.getElementById('origTexto').focus();
    else document.getElementById('origJson').focus();
  }
}
document.getElementById('tabTextoBtn').addEventListener('click', ()=>setTabActive('texto'));
document.getElementById('tabConversorBtn').addEventListener('click', ()=>setTabActive('conversor'));

/* fechar apenas o conversor (esconder admin modal content, mas manter admin aberto) */
function fecharConversor(){
  // fechar o painel inteiro do conversor/administrador (fecha modal)
  fecharAdministrador();
}

/* ====== Conversor JSON (Admin) - mant√©m comportamento anterior ====== */
function converterAdmin(){
  const raw = document.getElementById('origJson').value.trim();
  if(!raw){ alert('Cole o JSON original antes de converter.'); return; }
  try {
    const dados = JSON.parse(raw);
    const arr = Array.isArray(dados) ? dados : (dados.questoes || []);
    const convertido = arr.map((q,i) => {
      const enunciado = q.questao || q.pergunta || q.enunciado || q.texto || '';
      let opcoes = q.alternativas || q.opcoes || q.options || [];
      if(!Array.isArray(opcoes) && typeof opcoes === 'object') opcoes = Object.values(opcoes);
      let g = q.gabarito ?? q.resposta ?? q.resposta_correta ?? null;
      if(typeof g === 'string'){ const idx = g.trim().toUpperCase().charCodeAt(0)-65; g = isNaN(idx) ? null : idx; }
      return {
        id: i+1,
        disciplina: q.disciplina || 'Geral',
        enunciado,
        opcoes,
        gabarito: g,
        explicacao: q.comentario || q.coment√°rio || q.explicacao || q.explicacao_professor || '',
        dica: q.dica || ''
      };
    });
    document.getElementById('convJson').value = JSON.stringify(convertido, null, 2);
  } catch(e){
    alert('JSON inv√°lido: ' + e.message);
  }
}
function copiarConvertido(){ const t = document.getElementById('convJson').value; if(!t) return alert('Nada para copiar'); navigator.clipboard.writeText(t).then(()=>alert('Convertido copiado')); }
function baixarConvertido(){ const t = document.getElementById('convJson').value; if(!t) return alert('Nada para baixar'); const blob = new Blob([t], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'simulado_convertido.json'; a.click(); }
function limparConversor(){ document.getElementById('origJson').value=''; document.getElementById('convJson').value=''; }

/* ====== Texto -> JSON Inteligente ====== */
function converterTexto(){
  const text = document.getElementById('origTexto').value;
  if(!text.trim()){ alert('Cole algum texto antes.'); return; }

  // 1) tentar extrair JSON v√°lido dentro do texto (procura por primeiro bloco que possa ser JSON)
  const jsonFromText = extrairJsonDoTexto(text);
  if(jsonFromText) {
    // formatar e exibir
    const arr = Array.isArray(jsonFromText) ? jsonFromText : (jsonFromText.questoes || []);
    document.getElementById('jsonTexto').value = JSON.stringify(arr, null, 2);
    alert('JSON detectado e formatado.');
    return;
  }

  // 2) nenhum JSON detectado => realizar parsing heur√≠stico por blocos
  const gerado = gerarJsonDeTextoLivre(text);
  document.getElementById('jsonTexto').value = JSON.stringify(gerado, null, 2);
  alert('Texto convertido para JSON SABER (verifique e salve).');
}

/* tenta encontrar e parsear JSON dentro do texto (retorna objeto/array ou null) */
function extrairJsonDoTexto(text){
  // procura por chaves que pare√ßam JSON: primeiro "{"..."}" ou "["..."]"
  // vamos buscar pelo primeiro '[' que contenha objeto ou primeira '{' que contenha "quest" ou "enunciado"
  const firstBracket = text.indexOf('[');
  const firstBrace = text.indexOf('{');
  const possibleStarts = [];
  if(firstBracket !== -1) possibleStarts.push(firstBracket);
  if(firstBrace !== -1) possibleStarts.push(firstBrace);
  possibleStarts.sort((a,b)=>a-b);
  for(const start of possibleStarts){
    // tenta encontrar o fechamento correspondente (simples: tentar at√© o final e parsear pela primeira substring que parse)
    for(let end = text.length; end>start; end--){
      const candidate = text.substring(start, end);
      try {
        const parsed = JSON.parse(candidate);
        // se parseou e √© array ou objeto com questoes, retorna
        if(Array.isArray(parsed) || (parsed && typeof parsed === 'object')) return parsed;
      } catch(_) { /* ignora */ }
    }
  }
  return null;
}

/* heur√≠stica para converter texto livre em array de quest√µes */
function gerarJsonDeTextoLivre(text){
  // separa em blocos por duas quebras de linha (ou mais)
  const blocks = text.split(/\n{2,}/).map(b => b.trim()).filter(Boolean);
  const resultado = [];
  let idCounter = 1;
  for(const block of blocks){
    // tentar extrair quest√£o + alternativas
    // linhas do bloco
    const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
    if(!lines.length) continue;
    // detectar se o bloco √© um JSON parcial (por seguran√ßa)
    const firstLine = lines[0];
    // se primeira linha come√ßar com n√∫mero seguido de ponto, remover numeracao
    const enunciadoLine = firstLine.replace(/^\d+\.\s*/, '').replace(/^[\-\‚Ä¢]\s*/, '').trim();
    // coletar linhas que parecem alternativas (come√ßam com A) B) A. B. ou letra par√™ntese)
    const opsi = [];
    for(let i=1;i<lines.length;i++){
      const ln = lines[i];
      const m = ln.match(/^[A-Ea-e][\)\.\-]\s*(.+)$/);
      if(m){
        opsi.push(m[1].trim());
      } else {
        // tamb√©m aceitar linhas que come√ßam com letras mai√∫sculas + espa√ßo "A " or "A)" etc
        const m2 = ln.match(/^([A-Ea-e])\s+(.+)$/);
        if(m2) opsi.push(m2[2].trim());
        else {
          // talvez alternativa sem marcador: se a linha contiver 'A)' no meio, tente dividir
          const splitByLetter = ln.split(/\s{2,}/).map(s=>s.trim()).filter(Boolean);
          if(splitByLetter.length>1 && splitByLetter.every(s => s.length>0)) {
            // se parece com v√°rias partes, adicionar as partes como opcoes
            splitByLetter.forEach(s=> opsi.push(s));
          } else {
            // se n√£o for alternativa, pode ser continua√ß√£o do enunciado - anexar
            // se ainda n√£o coletamos opcoes, pode ser parte do enunciado
          }
        }
      }
    }
    // se n√£o encontrou alternativas usando marcadores, tentar detectar linhas que parecem alternativas por " - " ou por linhas separadas (se houver >=2 linhas depois)
    if(opsi.length===0 && lines.length>1){
      // assumir que as linhas 2.. s√£o op√ß√µes
      for(let i=1;i<lines.length;i++) opsi.push(lines[i]);
    }

    // se zero opcoes e apenas uma linha, pular (n√£o √© quest√£o)
    if(opsi.length===0 && lines.length===1) {
      // pode ser blocos longos que cont√™m v√°rias quest√µes - tentar separar por padr√£o nas linhas com "A)" etc (fallback)
      const altCandidates = block.split(/(?=\n[A-Ea-e][\)\.])/).map(s=>s.trim()).filter(Boolean);
      if(altCandidates.length>1){
        // processar cada como sub-bloco recursivamente
        altCandidates.forEach(sub => {
          const subJson = gerarJsonDeTextoLivre(sub);
          subJson.forEach(q=> resultado.push(q));
        });
        continue;
      } else {
        // tratar como enunciado sem op√ß√µes: criar quest√£o vazia (sem opcoes)
        resultado.push({
          id: idCounter++,
          disciplina: "Geral",
          enunciado: enunciadoLine,
          opcoes: [],
          gabarito: null,
          explicacao: "",
          dica: ""
        });
        continue;
      }
    }

    // limpar opcoes (remover prefixos tipo "A) ", "B. ")
    const opClean = opsi.map(o => o.replace(/^[A-Ea-e][\)\.\-\s]*\s*/, '').trim());
    // remover linhas vazias
    const opFinal = opClean.filter(Boolean);
    resultado.push({
      id: idCounter++,
      disciplina: "Geral",
      enunciado: enunciadoLine,
      opcoes: opFinal,
      gabarito: null,
      explicacao: "",
      dica: ""
    });
  }

  // se resultado vazio, tentar separar por linhas simples (fallback)
  if(resultado.length===0){
    const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
    for(let i=0;i<lines.length;i++){
      resultado.push({
        id: i+1,
        disciplina: "Geral",
        enunciado: lines[i],
        opcoes: [],
        gabarito: null,
        explicacao: "",
        dica: ""
      });
    }
  }

  return resultado;
}

/* utilit√°rios para copiar/baixar texto JSON gerado */
function copiarTextoJson(){ const t = document.getElementById('jsonTexto').value; if(!t) return alert('Nada para copiar'); navigator.clipboard.writeText(t).then(()=>alert('JSON copiado')); }
function baixarTextoJson(){ const t = document.getElementById('jsonTexto').value; if(!t) return alert('Nada para baixar'); const blob = new Blob([t], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'simulado_gerado.json'; a.click(); }
function limparTextoConversor(){ document.getElementById('origTexto').value=''; document.getElementById('jsonTexto').value=''; }

/* utilit√°rios conversor anterior (JSON) */
function copiarConvertido(){ const t = document.getElementById('convJson').value; if(!t) return alert('Nada para copiar'); navigator.clipboard.writeText(t).then(()=>alert('Convertido copiado')); }
function baixarConvertido(){ const t = document.getElementById('convJson').value; if(!t) return alert('Nada para baixar'); const blob = new Blob([t], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'simulado_convertido.json'; a.click(); }
function limparConversor(){ document.getElementById('origJson').value=''; document.getElementById('convJson').value=''; }

/* fechar apenas o conversor (solicita√ß√£o do usu√°rio): aqui fecha o modal inteiro */
function fecharConversor(){ fecharAdministrador(); }

/* fechar admin */
function fecharAdministrador(){ document.getElementById('adminModal').classList.add('hidden'); }

/* inicializa√ß√£o */
document.addEventListener('DOMContentLoaded', ()=> {
  carregarManifest();
  // ao abrir o admin, por padr√£o ativar 'Texto' (listeners j√° configurados via setTabActive)
  document.getElementById('tabTextoBtn').addEventListener('click', ()=> setTabActive('texto'));
  document.getElementById('tabConversorBtn').addEventListener('click', ()=> setTabActive('conversor'));
});
</script>
</body>
</html>
